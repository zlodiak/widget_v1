<!DOCTYPE html>

<html lang=ru>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title></title>
		<link href="css/styles.css" rel="stylesheet">
	</head>
	
	<body>
		<div id="happyWidgetParent"></div>

		<script> 
			scriptsColl = {};

		  function showContent(link) {
        console.log('================showContent');
	      var cont = document.getElementById('happyWidgetParent');
	      var http = createRequestObject();
	      if (http) {
	      	http.addEventListener("load", transferComplete, false);
          http.open('get', link);
          http.onreadystatechange = function() {
            console.log('================onreadystatechange');
            if (http.readyState == 4) {
          		var resp = http.responseText;
          		var repsWrapEl = document.createElement('div');

          		var startPos = resp.indexOf('<body>') + 6;
          		var endPos = resp.indexOf('</body>');
          		var respBodyEl = resp.substring(startPos, endPos);

          		repsWrapEl.innerHTML = respBodyEl;          		

							const styles = repsWrapEl.querySelectorAll('#styles link');
							if (styles) {
								Array.apply(null, styles).forEach(style => {
									const purePath = style.href.replace(location.href, '');
									const actualPath = link + purePath;
									style.href = actualPath;
								});
							}          		

							const scripts = repsWrapEl.querySelectorAll('#scripts script');
							if (scripts) {
								Array.apply(null, scripts).forEach((script, i) => {
									const purePath = script.src.replace(location.href, '');
									scriptsColl[i] = link + purePath;
                  // script.src = scriptsColl[i];
                  console.log('---', scriptsColl[i])
								});
							}  

              cont.appendChild(repsWrapEl);            
            }
          }

          http.send(null);
	      }
		  } 

		  function evalCode(url) {
		  	console.log('url', url)
	      var http = createRequestObject();
	      if (http) {
          http.open('get', url);
          http.onreadystatechange = function() {
            if (http.readyState == 4) {
              console.log('http.responseText', http.responseText.slice(0, 40))
              eval(http.responseText);
            }
          }
	        http.send(null);
	      }
		  } 		  

		  function transferComplete() {
        console.log('=============transferComplete');
		  	// console.log('complete ' + JSON.stringify(scriptsColl));
		  	// evalCode(scriptsColl[0]);
		  	// setTimeout(() => {
		  	// 	evalCode(scriptsColl[1]);
		  	// }, 2000);

        const codeColl = {};

        if (Object.keys(scriptsColl).length < 2) { return; }

        console.log('scriptsColl', scriptsColl)

        new Promise((resolve, reject) => {
          evalCode(scriptsColl[0]);
          console.log(1);  
          resolve(true);           
        })  
        .then(response => {
          evalCode(scriptsColl[1]);
          console.log(2);  
        })
        .catch(err => {
          console.log('error');
        })

		  }
    
		  function createRequestObject() {
		      try {
		          return new XMLHttpRequest()
		      } catch (e) {
		          try {
		              return new ActiveXObject('Msxml2.XMLHTTP')
		          } catch (e) {
		              try {
		                  return new ActiveXObject('Microsoft.XMLHTTP')
		              } catch (e) {
		                  return null;
		              }
		          }
		      }
		  }    

		  showContent('http://localhost/WIDGETS/body_widget/0_default/');   
		  // showContent('https://zlodiak.github.io/html/widgets/body_widget/0_default/');   
		</script>
	</body>
</html>
